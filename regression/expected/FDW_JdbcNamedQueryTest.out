-- @description query01 for JDBC named queries
-- start_ignore
-- end_ignore

SELECT gpdb_dept.name, count(*), max(gpdb_emp.salary)
FROM gpdb_dept JOIN gpdb_emp
                    ON gpdb_dept.id = gpdb_emp.dept_id
GROUP BY gpdb_dept.name;
  name   | count | max 
---------+-------+-----
 finance |     4 | 103
 it      |     2 |  96
 sales   |     3 | 120
(3 rows)

CREATE SERVER jdbc_test_named_query
    FOREIGN DATA WRAPPER jdbc_pxf_fdw
    OPTIONS ( config 'database' );

CREATE USER MAPPING FOR CURRENT_USER SERVER jdbc_test_named_query;

DROP FOREIGN TABLE IF EXISTS pxf_jdbc_read_named_query CASCADE;
NOTICE:  foreign table "pxf_jdbc_read_named_query" does not exist, skipping

CREATE FOREIGN TABLE pxf_jdbc_read_named_query
(
    name  text,
    count int,
    max   int
) SERVER jdbc_test_named_query 
    OPTIONS ( resource 'query:report' );

SELECT * FROM pxf_jdbc_read_named_query ORDER BY name;
  name   | count | max 
---------+-------+-----
 finance |     4 | 103
 it      |     2 |  96
 sales   |     3 | 120
(3 rows)

SELECT name, count FROM pxf_jdbc_read_named_query WHERE max > 100 ORDER BY name;
  name   | count 
---------+-------
 finance |     4
 sales   |     3
(2 rows)

SELECT max(max) FROM pxf_jdbc_read_named_query;
 max 
-----
 120
(1 row)

DROP FOREIGN TABLE IF EXISTS pxf_jdbc_read_named_query_partitioned CASCADE;
NOTICE:  foreign table "pxf_jdbc_read_named_query_partitioned" does not exist, skipping
CREATE FOREIGN TABLE pxf_jdbc_read_named_query_partitioned
(
    name  text,
    count int,
    max   int
) SERVER jdbc_test_named_query 
    OPTIONS ( resource 'query:report', partition_by 'count:int', range '1:5', interval '1' );

SELECT * FROM pxf_jdbc_read_named_query_partitioned ORDER BY name;
  name   | count | max 
---------+-------+-----
 finance |     4 | 103
 it      |     2 |  96
 sales   |     3 | 120
(3 rows)

SELECT name, count FROM pxf_jdbc_read_named_query_partitioned WHERE count > 2 ORDER BY name;
  name   | count 
---------+-------
 finance |     4
 sales   |     3
(2 rows)